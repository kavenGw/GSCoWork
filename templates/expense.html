{{template "layout" .}}

{{define "content"}}
<h2>费用管理</h2>

{{if .Error}}<p class="error">{{.Error}}</p>{{end}}
{{if .Success}}<p class="success">{{.Success}}</p>{{end}}

<!-- 用户列表管理 -->
<div class="expense-section">
    <div class="expense-header">
        <h3>用户列表</h3>
    </div>

    {{if .CurrentUser.IsAdmin}}
    <div class="user-add-form">
        <form method="POST" action="/expense/user/add" class="inline-form-row">
            <input type="text" name="username" placeholder="用户名" required>
            <input type="password" name="password" placeholder="密码" required>
            <input type="text" name="display_name" placeholder="显示名称" required>
            <button type="submit" class="btn btn-add">添加用户</button>
        </form>
    </div>
    {{end}}

    <table class="user-table user-list-table">
        <thead>
            <tr>
                <th>ID</th>
                <th>用户名</th>
                <th>显示名称</th>
                <th>管理员</th>
                {{if .CurrentUser.IsAdmin}}<th>操作</th>{{end}}
            </tr>
        </thead>
        <tbody>
            {{range .Users}}
            <tr>
                <td>{{.UserID}}</td>
                <td>{{.Username}}</td>
                <td>{{.DisplayName}}</td>
                <td>{{if .IsAdmin}}是{{else}}否{{end}}</td>
                {{if $.CurrentUser.IsAdmin}}
                <td class="actions">
                    <form method="POST" action="/expense/user/delete" class="inline-form" onsubmit="return confirm('确定删除用户 {{.Username}} 吗？');">
                        <input type="hidden" name="id" value="{{.UserID}}">
                        <button type="submit" class="btn btn-delete">删除</button>
                    </form>
                </td>
                {{end}}
            </tr>
            {{end}}
        </tbody>
    </table>
</div>

<!-- 费用计算 -->
<div class="expense-section">
    <div class="expense-header">
        <h3>费用配置</h3>
        <a href="/expense/history" class="btn btn-history">查看历史记录</a>
    </div>

    <form id="expense-form" method="POST" action="/expense/save">
        <div class="expense-config">
            <div class="config-row">
                <div class="form-group">
                    <label>日期范围</label>
                    <div class="date-range">
                        <input type="date" name="start_date" id="start_date" value="{{.StartDate}}" required>
                        <span>至</span>
                        <input type="date" name="end_date" id="end_date" value="{{.EndDate}}" required>
                    </div>
                </div>
            </div>
            <div class="config-row">
                <div class="form-group">
                    <label>账户费用</label>
                    <input type="number" name="account_fee" id="account_fee" value="{{.AccountFee}}" step="0.01" required>
                </div>
                <div class="form-group">
                    <label>服务器费用（年费）</label>
                    <input type="number" name="server_fee" id="server_fee" value="{{.ServerFee}}" step="0.01" required>
                </div>
            </div>
            <div class="config-info">
                <p>计算公式：用户费用 = 补贴额 + (用户实际使用量 / 总实际使用量) × 剩余费用</p>
                <p>其中：实际使用量 = 总额 - 上周期，补贴额 = 总费用 × (补/100)，剩余费用 = 总费用 - 所有补贴总额，总费用 = 账户费用 + 服务器费用/12</p>
            </div>
        </div>

        <div class="expense-users">
            <h3>用户使用量</h3>
            <table class="user-table">
                <thead>
                    <tr>
                        <th>用户</th>
                        <th>总额</th>
                        <th>上周期</th>
                        <th>实际使用</th>
                        <th>补(%)</th>
                        <th>费用</th>
                    </tr>
                </thead>
                <tbody>
                    {{range .Users}}
                    <tr data-user-id="{{.UserID}}">
                        <td>{{.DisplayName}} ({{.Username}})</td>
                        <td>
                            <input type="number"
                                   name="usage_{{.UserID}}"
                                   class="usage-input"
                                   data-user-id="{{.UserID}}"
                                   value="{{.Usage}}"
                                   step="0.01"
                                   min="0"
                                   placeholder="输入总额">
                        </td>
                        <td>
                            <input type="number"
                                   name="prev_usage_{{.UserID}}"
                                   class="prev-usage-input"
                                   data-user-id="{{.UserID}}"
                                   value="{{.PrevUsage}}"
                                   step="0.01"
                                   min="0"
                                   placeholder="上周期">
                        </td>
                        <td class="actual-usage-cell" data-user-id="{{.UserID}}">0.00</td>
                        <td>
                            <input type="number"
                                   name="supplement_{{.UserID}}"
                                   class="supplement-input"
                                   data-user-id="{{.UserID}}"
                                   value="{{.Supplement}}"
                                   step="0.01"
                                   min="0"
                                   max="100"
                                   placeholder="补%">
                        </td>
                        <td class="cost-cell" data-user-id="{{.UserID}}">¥0.00</td>
                    </tr>
                    {{end}}
                </tbody>
                <tfoot>
                    <tr class="total-row">
                        <td><strong>合计</strong></td>
                        <td id="total-raw-usage">0</td>
                        <td id="total-prev-usage">0</td>
                        <td id="total-usage">0</td>
                        <td id="total-supplement">0%</td>
                        <td id="total-cost">¥0.00</td>
                    </tr>
                </tfoot>
            </table>
        </div>

        <div class="expense-actions">
            <button type="button" class="btn btn-calculate" onclick="calculateExpense()">计算费用</button>
            <button type="button" class="btn btn-cache" onclick="cacheExpenseData()">缓存数据</button>
            <button type="submit" class="btn btn-save">保存记录</button>
        </div>
    </form>
</div>

<script>
const EXPENSE_CACHE_KEY = 'expense_form_cache';

// 缓存表单数据到 localStorage
function cacheExpenseData() {
    const cacheData = {
        account_fee: document.getElementById('account_fee').value,
        server_fee: document.getElementById('server_fee').value,
        usages: {},
        prev_usages: {},
        supplements: {},
        cached_at: new Date().toISOString()
    };

    // 收集所有用户的使用量、上周期和补贴
    document.querySelectorAll('.usage-input').forEach(input => {
        const userId = input.dataset.userId;
        cacheData.usages[userId] = input.value;
    });

    document.querySelectorAll('.prev-usage-input').forEach(input => {
        const userId = input.dataset.userId;
        cacheData.prev_usages[userId] = input.value;
    });

    document.querySelectorAll('.supplement-input').forEach(input => {
        const userId = input.dataset.userId;
        cacheData.supplements[userId] = input.value;
    });

    localStorage.setItem(EXPENSE_CACHE_KEY, JSON.stringify(cacheData));
    alert('数据已缓存！下次打开页面将自动加载缓存数据。');
}

// 从 localStorage 加载缓存数据
function loadCachedData() {
    const cached = localStorage.getItem(EXPENSE_CACHE_KEY);
    if (!cached) return;

    try {
        const cacheData = JSON.parse(cached);

        // 恢复费用配置
        if (cacheData.account_fee) {
            document.getElementById('account_fee').value = cacheData.account_fee;
        }
        if (cacheData.server_fee) {
            document.getElementById('server_fee').value = cacheData.server_fee;
        }

        // 恢复用户使用量
        if (cacheData.usages) {
            for (const [userId, value] of Object.entries(cacheData.usages)) {
                const input = document.querySelector(`.usage-input[data-user-id="${userId}"]`);
                if (input && value) {
                    input.value = value;
                }
            }
        }

        // 恢复用户上周期数据
        if (cacheData.prev_usages) {
            for (const [userId, value] of Object.entries(cacheData.prev_usages)) {
                const input = document.querySelector(`.prev-usage-input[data-user-id="${userId}"]`);
                if (input && value) {
                    input.value = value;
                }
            }
        }

        // 恢复用户补贴
        if (cacheData.supplements) {
            for (const [userId, value] of Object.entries(cacheData.supplements)) {
                const input = document.querySelector(`.supplement-input[data-user-id="${userId}"]`);
                if (input && value) {
                    input.value = value;
                }
            }
        }

        // 自动计算费用
        calculateExpense();

        // 显示缓存时间提示
        if (cacheData.cached_at) {
            const cachedDate = new Date(cacheData.cached_at);
            console.log('已加载缓存数据，缓存时间：' + cachedDate.toLocaleString());
        }
    } catch (e) {
        console.error('加载缓存数据失败:', e);
    }
}

// 页面加载时自动加载缓存
document.addEventListener('DOMContentLoaded', loadCachedData);

function calculateExpense() {
    const form = document.getElementById('expense-form');
    const formData = new FormData(form);

    fetch('/expense/calculate', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        // 更新总使用量（实际使用量）
        document.getElementById('total-usage').textContent = data.total_usage.toFixed(2);

        // 更新总额和上周期合计
        let totalRawUsage = 0;
        let totalPrevUsage = 0;
        document.querySelectorAll('.usage-input').forEach(input => {
            totalRawUsage += parseFloat(input.value) || 0;
        });
        document.querySelectorAll('.prev-usage-input').forEach(input => {
            totalPrevUsage += parseFloat(input.value) || 0;
        });
        document.getElementById('total-raw-usage').textContent = totalRawUsage.toFixed(2);
        document.getElementById('total-prev-usage').textContent = totalPrevUsage.toFixed(2);

        // 计算总补贴百分比
        let totalSupplement = 0;
        data.results.forEach(result => {
            totalSupplement += result.supplement || 0;
        });
        document.getElementById('total-supplement').textContent = totalSupplement.toFixed(2) + '%';

        // 更新每个用户的实际使用量和费用
        let totalCost = 0;
        data.results.forEach(result => {
            // 更新实际使用量显示
            const actualUsageCell = document.querySelector(`.actual-usage-cell[data-user-id="${result.user_id}"]`);
            if (actualUsageCell) {
                actualUsageCell.textContent = (result.actual_usage || 0).toFixed(2);
            }

            // 更新费用
            const costCell = document.querySelector(`.cost-cell[data-user-id="${result.user_id}"]`);
            if (costCell) {
                costCell.textContent = '¥' + result.cost.toFixed(2);
                totalCost += result.cost;
            }
        });

        document.getElementById('total-cost').textContent = '¥' + totalCost.toFixed(2);
    })
    .catch(error => {
        console.error('计算失败:', error);
        alert('计算失败，请重试');
    });
}

// 监听使用量输入变化，自动计算
let debounceTimer;
document.querySelectorAll('.usage-input').forEach(input => {
    input.addEventListener('input', () => {
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(calculateExpense, 300);
    });
});

// 监听上周期输入变化，自动计算
document.querySelectorAll('.prev-usage-input').forEach(input => {
    input.addEventListener('input', () => {
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(calculateExpense, 300);
    });
});

// 监听补贴输入变化，自动计算
document.querySelectorAll('.supplement-input').forEach(input => {
    input.addEventListener('input', () => {
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(calculateExpense, 300);
    });
});

// 监听费用配置变化
document.getElementById('account_fee').addEventListener('input', () => {
    clearTimeout(debounceTimer);
    debounceTimer = setTimeout(calculateExpense, 300);
});
document.getElementById('server_fee').addEventListener('input', () => {
    clearTimeout(debounceTimer);
    debounceTimer = setTimeout(calculateExpense, 300);
});
</script>
{{end}}
