{{template "layout" .}}

{{define "content"}}
<div class="month-nav">
    <a href="/?month={{.PrevMonth}}">&larr; ä¸Šæœˆ</a>
    <h2>{{.MonthName}}</h2>
    <a href="/?month={{.NextMonth}}">ä¸‹æœˆ &rarr;</a>
</div>

{{range .Calendars}}
<div class="user-calendar">
    <h3>{{.User.DisplayName}}</h3>
    <table class="calendar">
        <thead>
            <tr>
                <th>æ—¥</th><th>ä¸€</th><th>äºŒ</th><th>ä¸‰</th><th>å››</th><th class="friday">äº”</th><th>å…­</th>
            </tr>
        </thead>
        <tbody>
            {{$isOwner := .IsOwner}}
            {{$userID := .User.ID}}
            {{range .Weeks}}
            <tr>
                {{range $idx, $day := .}}
                <td>
                    {{if $day.Day}}
                    <div class="day-cell {{statusClass $day.Status}}{{if $isOwner}} editable{{end}}{{if $day.IsToday}} today{{end}}{{if eq $idx 5}} friday{{end}}"
                         {{if $isOwner}}onclick="toggleStatus(this, {{$userID}}, '{{$day.Date}}')"{{end}}
                         data-status="{{$day.Status}}">
                        <span class="day-num">{{$day.Day}}</span>
                        <span class="day-label">{{statusLabel $day.Status}}</span>
                    </div>
                    {{end}}
                </td>
                {{end}}
            </tr>
            {{end}}
        </tbody>
    </table>
</div>
{{end}}

<script>
function toggleStatus(el, userID, date) {
    fetch('/schedule', {
        method: 'POST',
        headers: {'Content-Type': 'application/x-www-form-urlencoded'},
        body: 'user_id=' + userID + '&date=' + encodeURIComponent(date)
    })
    .then(r => r.json())
    .then(data => {
        el.dataset.status = data.status;
        var extra = '';
        if (el.classList.contains('today')) extra += ' today';
        if (el.classList.contains('friday')) extra += ' friday';
        el.className = 'day-cell ' + statusClass(data.status) + ' editable' + extra;
        el.querySelector('.day-label').textContent = statusLabel(data.status);
    });
}

function statusClass(s) {
    switch(s) {
        case 2: return 'rest';
        case 3: return 'fire';
        default: return 'default';
    }
}

function statusLabel(s) {
    switch(s) {
        case 2: return 'ä¼‘';
        case 3: return 'ğŸ®ğŸ´';
        default: return '';
    }
}
</script>
{{end}}
